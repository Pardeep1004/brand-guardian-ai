<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Guardian AI | Premium Compliance Auditing</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --secondary: #a855f7;
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(168, 85, 247, 0.15) 0%, transparent 40%);
            overflow-x: hidden;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 4rem;
            padding-top: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3);
        }

        .logo-icon svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p.subtitle {
            color: var(--text-dim);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 1rem auto 0;
        }

        .search-section {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 3rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeInUp 0.8s ease-out 0.2s backwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-section:focus-within {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .input-group {
            display: flex;
            gap: 1rem;
        }

        input {
            flex: 1;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 1.2rem 1.5rem;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        input:focus {
            border-color: var(--primary);
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 14px;
            padding: 0 2.5rem;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
            filter: brightness(1.1);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 2rem 0;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(99, 102, 241, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            margin: 0 auto 1.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .results-section {
            display: none;
            animation: fadeInUp 0.8s ease-out;
        }

        .status-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-info h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .badge {
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
        }

        .badge-fail {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-pass {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .report-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .report-card h3 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            color: var(--primary-light);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .summary-text {
            line-height: 1.8;
            color: var(--text-dim);
            font-size: 1.05rem;
        }

        .summary-text h1,
        .summary-text h2,
        .summary-text h3 {
            color: var(--text-main);
            margin: 1.5rem 0 1rem;
            font-family: 'Outfit', sans-serif;
        }

        .summary-text h4 {
            color: var(--primary-light);
            margin: 1rem 0;
        }

        .summary-text ul,
        .summary-text ol {
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }

        .summary-text li {
            margin-bottom: 0.5rem;
        }

        .summary-text code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: monospace;
            color: var(--secondary);
        }

        .summary-text strong {
            color: white;
            font-weight: 600;
        }

        .summary-text p {
            margin-bottom: 1rem;
        }

        .violations-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .violation-card {
            background: rgba(15, 23, 42, 0.4);
            border-radius: 16px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary);
            transition: transform 0.2s ease;
        }

        .violation-card:hover {
            transform: translateX(10px);
            background: rgba(15, 23, 42, 0.6);
        }

        .violation-card.CRITICAL {
            border-left-color: var(--error);
        }

        .violation-card.WARNING {
            border-left-color: var(--warning);
        }

        .violation-card.INFO {
            border-left-color: var(--primary);
        }

        .violation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .violation-category {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .violation-severity {
            font-size: 0.75rem;
            font-weight: 800;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
        }

        .severity-CRITICAL {
            background: var(--error);
            color: white;
        }

        .severity-WARNING {
            background: var(--warning);
            color: black;
        }

        .severity-INFO {
            background: var(--primary);
            color: white;
        }

        .violation-description {
            color: var(--text-dim);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        footer {
            margin-top: auto;
            padding: 3rem 0;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-dim);
        }

        /* Particles animation for background */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            width: 100%;
            height: 100%;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            .input-group {
                flex-direction: column;
            }

            button {
                padding: 1.2rem;
            }
        }
    </style>
</head>

<body>
    <canvas id="bg-canvas"></canvas>

    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
                    </svg>
                </div>
            </div>
            <h1>Brand Guardian AI</h1>
            <p class="subtitle">Ensuring your video content adheres to the highest brand compliance standards with
                intelligent AI auditing.</p>
        </header>

        <section class="search-section">
            <div class="input-group">
                <select id="region-select"
                    style="background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid var(--glass-border); border-radius: 8px; padding: 0.8rem; margin-right: 0.5rem; outline: none;">
                    <option value="Global" style="background: #0f172a;" selected>Global</option>
                    <option value="Europe" style="background: #0f172a;">Europe</option>
                    <option value="North America" style="background: #0f172a;">North America</option>
                    <option value="Asia" style="background: #0f172a;">Asia</option>
                </select>
                <input type="text" id="video-url" placeholder="Upload your youtube video link here..." value="">
                <button id="audit-btn">Start Audit</button>
            </div>
        </section>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3 id="loading-status">Initializing Audit...</h3>
            <p class="subtitle" id="loading-subtitle">Checking transcript, OCR, and visual cues for compliance.</p>
            <div
                style="margin-top: 1rem; font-size: 0.8rem; color: var(--primary-light); display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <span
                    style="display: inline-block; width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 1.5s infinite;"></span>
                <span>Live Status: <span id="live-status-text">Connecting...</span></span>
            </div>
            <p id="poll-timer" style="font-size: 0.7rem; color: var(--text-dim); margin-top: 0.5rem;"></p>
        </div>

        <style>
            @keyframes pulse {
                0% {
                    opacity: 1;
                    transform: scale(1);
                }

                50% {
                    opacity: 0.4;
                    transform: scale(1.2);
                }

                100% {
                    opacity: 1;
                    transform: scale(1);
                }
            }
        </style>

        <section class="results-section" id="history-section" style="display: block; margin-bottom: 3rem;">
            <div class="report-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 0;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        Audit History
                    </h3>
                    <button id="refresh-history-btn" style="padding: 0.5rem 1rem; font-size: 0.8rem;">Refresh</button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--glass-border); text-align: left;">
                                <th style="padding: 1rem; color: var(--text-dim);">Date</th>
                                <th style="padding: 1rem; color: var(--text-dim);">Video ID</th>
                                <th style="padding: 1rem; color: var(--text-dim);">Region</th>
                                <th style="padding: 1rem; color: var(--text-dim);">Status</th>
                                <th style="padding: 1rem; color: var(--text-dim);">Action</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <!-- History items injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <style>
            .history-row:hover {
                background: rgba(255, 255, 255, 0.05);
                cursor: pointer;
            }

            .status-badge-mini {
                padding: 0.2rem 0.6rem;
                border-radius: 4px;
                font-size: 0.7rem;
                font-weight: 700;
            }
        </style>

        <section class="results-section" id="results">
            <div class="status-card" id="status-card">
                <div class="status-info">
                    <h2 id="video-id-display">Video Audit</h2>
                    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.25rem;">
                        <p id="session-id-display" style="font-size: 0.8rem; color: var(--text-dim)"></p>
                        <span id="region-badge-display" class="status-badge-mini"
                            style="background: rgba(99, 102, 241, 0.1); color: var(--primary-light); border: 1px solid rgba(99, 102, 241, 0.2); font-size: 0.65rem;">Global</span>
                    </div>
                </div>
                <div id="status-badge" class="badge">PENDING</div>
            </div>

            <div class="report-card">
                <h3>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Analysis Summary
                </h3>
                <p class="summary-text" id="final-report">Audit report summary will appear here.</p>
            </div>

            <div class="report-card">
                <h3 id="violations-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                        </path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Detected Violations
                </h3>
                <div class="violations-grid" id="violations-grid">
                    <!-- Violations will be injected here -->
                </div>
            </div>

            <div class="report-card" id="chat-section">
                <h3>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Chat with Audit Guardian
                </h3>
                <div id="chat-history"
                    style="height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; background: rgba(15, 23, 42, 0.4); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--glass-border);">
                    <p style="color: var(--text-dim); text-align: center; margin-top: 100px;">Audit results will appear
                        here. After processing, you can ask questions about the report.</p>
                </div>
                <div class="input-group">
                    <input type="text" id="chat-input"
                        placeholder="Ask a question about this audit (e.g., 'What was the specific greenwashing violation?')"
                        style="padding: 0.8rem 1rem; font-size: 0.9rem;">
                    <button id="chat-send-btn" style="padding: 0 1.5rem; font-size: 0.9rem;">Send</button>
                </div>
            </div>
        </section>
    </div>

    <footer>
        <p>&copy; 2026 Brand Guardian AI. Powered by FastAPI & Azure AI.</p>
    </footer>

    <script>
        // Background particles
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 1;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;
                this.opacity = Math.random() * 0.5;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.x > canvas.width) this.x = 0;
                else if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0;
                else if (this.y < 0) this.y = canvas.height;
            }

            draw() {
                ctx.fillStyle = `rgba(148, 163, 184, ${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function createParticles() {
            for (let i = 0; i < 50; i++) {
                particles.push(new Particle());
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(animate);
        }

        const historyTableBody = document.getElementById('history-table-body');
        const refreshHistoryBtn = document.getElementById('refresh-history-btn');

        async function fetchHistory() {
            try {
                const response = await fetch('/history?limit=10');
                if (!response.ok) return;
                const data = await response.json();
                renderHistory(data);
            } catch (err) {
                console.error('History fetch error:', err);
            }
        }

        function renderHistory(items) {
            historyTableBody.innerHTML = '';
            if (items.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-dim);">No past audits found.</td></tr>';
                return;
            }

            items.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'history-row';
                row.style.borderBottom = '1px solid var(--glass-border)';

                const date = item.created_at ? new Date(item.created_at).toLocaleDateString() : 'N/A';
                const statusClass = item.final_status === 'PASS' ? 'badge-pass' : (item.final_status === 'FAIL' ? 'badge-fail' : '');
                const statusText = item.final_status || item.status;
                const region = item.region || 'Global';

                row.innerHTML = `
                    <td style="padding: 1rem;">${date}</td>
                    <td style="padding: 1rem;">${item.video_id || '---'}</td>
                    <td style="padding: 1rem;"><span style="color: var(--text-dim); font-size: 0.8rem;">${region}</span></td>
                    <td style="padding: 1rem;"><span class="status-badge-mini ${statusClass}">${statusText}</span></td>
                    <td style="padding: 1rem;"><button class="view-btn" style="padding: 0.3rem 0.8rem; font-size: 0.7rem;">View</button></td>
                `;

                row.addEventListener('click', () => displayResults(item));
                historyTableBody.appendChild(row);
            });
        }

        refreshHistoryBtn.addEventListener('click', fetchHistory);

        window.addEventListener('load', () => {
            initCanvas();
            createParticles();
            animate();
            fetchHistory();
        });

        // Audit Logic
        const btn = document.getElementById('audit-btn');
        const input = document.getElementById('video-url');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const violationsGrid = document.getElementById('violations-grid');
        const loadingStatusText = document.querySelector('#loading h3');

        // Chat Elements
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatHistory = document.getElementById('chat-history');

        let currentTaskId = null; // Store current task ID for chat

        // Chat Functionality
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message || !currentTaskId) return;

            // Add user message
            appendMessage('User', message);
            chatInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: currentTaskId, message: message })
                });

                if (!response.ok) throw new Error('Chat failed');

                const data = await response.json();
                appendMessage('Guardian', data.response);
            } catch (err) {
                appendMessage('System', 'Error: Could not get response. ' + err.message);
            }
        }

        function appendMessage(sender, text) {
            const msgDiv = document.createElement('div');
            const isUser = sender === 'User';
            msgDiv.style.alignSelf = isUser ? 'flex-end' : 'flex-start';
            msgDiv.style.background = isUser ? 'var(--primary)' : 'rgba(255,255,255,0.1)';
            msgDiv.style.padding = '0.8rem 1rem';
            msgDiv.style.borderRadius = '12px';
            msgDiv.style.maxWidth = '80%';
            msgDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        if (chatSendBtn) {
            chatSendBtn.addEventListener('click', sendChatMessage);
        }
        if (chatInput) {
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
        }


        let pollInterval;

        btn.addEventListener('click', async () => {
            const videoUrl = document.getElementById('video-url').value;
            const region = document.getElementById('region-select').value;

            if (!videoUrl) {
                alert('Please enter a YouTube URL');
                return;
            }

            // Show loading
            btn.disabled = true;
            loading.style.display = 'block';
            results.style.display = 'none';
            violationsGrid.innerHTML = '';
            loadingStatusText.textContent = 'Initializing Audit...';

            try {
                const response = await fetch('/audit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_url: videoUrl, region: region })
                });

                if (!response.ok) throw new Error('Failed to start audit');

                const data = await response.json();
                const taskId = data.task_id;

                // Start Polling
                startPolling(taskId);

            } catch (err) {
                console.error('Audit initiation failed:', err);
                alert('Connection Error: ' + err.message + '\n\nPlease ensure the backend server is running.');
                loading.style.display = 'none';
                btn.disabled = false;
            }
        });

        function startPolling(taskId) {
            if (pollInterval) clearInterval(pollInterval);
            const liveStatusText = document.getElementById('live-status-text');
            const pollTimer = document.getElementById('poll-timer');
            const loadingStatus = document.getElementById('loading-status');

            pollInterval = setInterval(async () => {
                try {
                    const now = new Date().toLocaleTimeString();
                    pollTimer.textContent = `Last sync: ${now}`;

                    const response = await fetch(`/status/${taskId}`);
                    if (!response.ok) throw new Error('Failed to fetch status');

                    const data = await response.json();
                    liveStatusText.textContent = data.status;

                    if (data.status === 'PROCESSING') {
                        loadingStatus.textContent = 'Analyzing Video Content...';
                    } else if (data.status === 'COMPLETED') {
                        clearInterval(pollInterval);
                        loading.style.display = 'none';
                        btn.disabled = false;
                        displayResults(data);
                        fetchHistory();
                    } else if (data.status === 'FAILED') {
                        clearInterval(pollInterval);
                        loading.style.display = 'none';
                        btn.disabled = false;
                        alert('Audit failed: ' + (data.errors ? data.errors.join(', ') : 'Unknown error'));
                        fetchHistory();
                    }
                } catch (err) {
                    console.error('Polling error:', err);
                    clearInterval(pollInterval);
                    loading.style.display = 'none';
                    btn.disabled = false;
                    alert('Error checking audit status: ' + err.message);
                }
            }, 3000); // Poll every 3 seconds
        }

        function displayResults(data) {
            results.style.display = 'block';

            currentTaskId = data.task_id; // Set task ID for chat
            if (chatHistory) chatHistory.innerHTML = ''; // Request user to ask questions first

            // Populate Overview
            document.getElementById('video-id-display').textContent = data.video_id || 'N/A';
            document.getElementById('session-id-display').textContent = 'ID: ' + (data.task_id || data.id);
            document.getElementById('region-badge-display').textContent = data.region || 'Global';

            const statusBadge = document.getElementById('status-badge');

            if (data.final_status === 'PASS') {
                statusBadge.textContent = 'PASS';
                statusBadge.className = 'badge badge-pass';
            } else {
                statusBadge.textContent = 'FAIL';
                statusBadge.className = 'badge badge-fail';
            }
            document.getElementById('final-report').innerHTML = marked.parse(data.final_report || 'No report generated yet.');

            violationsGrid.innerHTML = '';
            const violations = data.compliance_results || [];

            // Ensure violations title is visible and updated
            const violationsTitle = document.getElementById('violations-title');
            violationsTitle.style.display = 'flex';
            violationsTitle.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                Detected Violations (${violations.length})
            `;

            if (violations.length === 0) {
                violationsGrid.innerHTML = '<div class="empty-state">No violations detected for this region. The content is compliant.</div>';
            } else {
                violations.forEach(v => {
                    const card = document.createElement('div');
                    card.className = `violation-card ${v.severity}`;
                    card.innerHTML = `
                        <div class="violation-header">
                            <span class="violation-category">${v.category}</span>
                            <span class="violation-severity severity-${v.severity}">${v.severity}</span>
                        </div>
                        <p class="violation-description">${v.description}</p>
                    `;
                    violationsGrid.appendChild(card);
                });
            }

            // Scroll to results
            results.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>

</html>